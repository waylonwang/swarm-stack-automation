---
# Update Time: 2024-1-4 1:05
version: "3.4"

x-defines:
  service-common: &service-common-ref
    networks: [network_cluster]
  env-common: &env-common-ref
    NO_PROXY: ${NO_PROXY:-localhost,127.0.0.1,::1}
    TZ: ${TZ:-Asia/Shanghai}    
  env-proxy: &env-proxy-ref
    HTTP_PROXY: ${OPENCLASH_HTTP_PROXY}
    HTTPS_PROXY: ${OPENCLASH_HTTP_PROXY}
    http_proxy: ${OPENCLASH_HTTP_PROXY}
    https_proxy: ${OPENCLASH_HTTP_PROXY}
  deploy-common: &deploy-common-ref
    mode: replicated
    replicas: 1
    restart_policy:
      condition: on-failure
      delay: 5s      
  placement-default: &placement-default-ref
    placement:
      constraints:
        - node.labels.type == vm
        - node.labels.automation == true
  driver-common: &driver-common-ref
    type: nfs
    o: addr=${NFS_SERVER},rw,nfsvers=4

services:
  # ------------------------------------------------------------
  # Home Assistant家庭自动化系统
  # ------------------------------------------------------------
  homeassistant:
    <<: *service-common-ref
    # image-ref: ghcr.io/home-assistant/home-assistant:stable
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/home-assistant/home-assistant:stable
    environment:
      <<: [*env-common-ref, *env-proxy-ref]
    volumes:
      - nfs_homeassistant_conf:/config
      - /etc/localtime:/etc/localtime:ro
      - /run/dbus:/run/dbus:ro
    logging:
      driver: fluentd
      options:
        tag: docker.automation.homeassistant
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.homeassistant.rule=Host(`ha.${DOMAIN_SWARM}`,`ha.${DOMAIN_EMERGENCY}`)
        - traefik.http.routers.homeassistant.entrypoints=websecure
        - traefik.http.routers.homeassistant.service=homeassistant
        - traefik.http.routers.homeassistant.middlewares=auth,cors-headers@file,normal-chain@file
        - traefik.http.services.homeassistant.loadbalancer.server.port=8123
        - homepage.group=AI & Automation
        - homepage.name=Home Assistant
        - homepage.icon=home-assistant.png
        - homepage.href=https://ha.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        - homepage.description=智能家居
        - homepage.siteMonitor=http://homeassistant:8123
        - homepage.weight=10
      <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # n8n Workflow Automation
  # ------------------------------------------------------------
  # n8n:
  #   <<: *service-common-ref
  #   # image-ref: docker.n8n.io/n8nio/n8n
  #   image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/n8nio/n8n:latest
  #   environment:
  #     <<: [*env-common-ref, *env-proxy-ref]
  #     N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
  #     N8N_DEFAULT_LOCALE: zh-CN
  #     N8N_RUNNERS_ENABLED: "true"
  #     N8N_SECURE_COOKIE: "false"
  #   volumes:
  #     - nfs_n8n_data:/home/node/.n8n
  #     - nfs_n8n_ui:/usr/local/lib/node_modules/n8n/node_modules/n8n-editor-ui/dist
  #   logging:
  #     driver: fluentd
  #     options:
  #       tag: docker.automation.n8n
  #       fluentd-async-connect: "true"
  #   deploy:
  #     labels:
  #       # Traefik配置
  #       - traefik.enable=true
  #       - traefik.http.routers.n8n.rule=Host(`n8n.${DOMAIN_SWARM}`,`n8n.${DOMAIN_EMERGENCY}`)
  #       - traefik.http.routers.n8n.entrypoints=websecure
  #       - traefik.http.routers.n8n.service=n8n
  #       - traefik.http.routers.n8n.middlewares=auth,cors-headers@file,normal-chain@file
  #       - traefik.http.services.n8n.loadbalancer.server.port=5678
        
  #       # Homepage配置
  #       - homepage.group=AI & Automation
  #       - homepage.name=n8n
  #       - homepage.icon=n8n.png
  #       - homepage.href=https://n8n.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
  #       - homepage.description=Workflow automation platform
  #       - homepage.siteMonitor=http://n8n:5678
  #       - homepage.weight=100
  #     <<: [*deploy-common-ref, *placement-default-ref]

  # ------------------------------------------------------------
  # openclaw gateway
  # ------------------------------------------------------------
  openclaw-gateway:
    <<: *service-common-ref
    # image-ref: ghcr.io/waylonwang/openclaw:main
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/openclaw/openclaw:main   
    command: [
      "node",
      "dist/index.js",
      "gateway",
      "--bind",
      "lan",
      "--port",
      "18789"
    ]     
    environment:
      <<: [*env-common-ref, *env-proxy-ref]
      HOME: /home/code
      TERM: xterm-256color
      OPENCLAW_GATEWAY_TOKEN: "zRMxEKpTw6AL3fdUdkSm7F3A1etkC4MG"
    volumes:
      - nfs_openclaw_conf:/home/node/.openclaw
      - nfs_openclaw_workspace:/home/node/.openclaw/workspace
    ports:
      - 18790:18790
      - 18789:18789
    logging:
      driver: fluentd
      options:
        tag: docker.automation.openclaw-gateway
        fluentd-async-connect: "true"
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.openclaw-gateway.rule=Host(`claw.${DOMAIN_SWARM}`,`claw.${DOMAIN_EMERGENCY}`)
        - traefik.http.routers.openclaw-gateway.entrypoints=websecure
        - traefik.http.routers.openclaw-gateway.service=openclaw-gateway
        - traefik.http.routers.openclaw-gateway.middlewares=auth,cors-headers@file,normal-chain@file
        - traefik.http.services.openclaw-gateway.loadbalancer.server.port=18789
        - homepage.group=AI & Automation
        - homepage.name=Open Claw
        - homepage.icon=open-claw.png
        - homepage.href=https://ha.${DOMAIN_SWARM}:${EXTERNAL_PORT}/
        - homepage.description=Open Claw
        - homepage.siteMonitor=http://homeassistant:8123
        - homepage.weight=10
      <<: [*deploy-common-ref, *placement-default-ref]
  openclaw-cli:
    <<: *service-common-ref
    # image-ref: ghcr.io/waylonwang/openclaw:main  
    image: registry.${DOMAIN_SWARM}:${EXTERNAL_PORT}/openclaw/openclaw:main  
    entrypoint: ["node", "dist/index.js"]    
    environment:
      <<: [*env-common-ref, *env-proxy-ref]
      HOME: /home/node
      TERM: xterm-256color
      BROWSER: echo
      OPENCLAW_GATEWAY_TOKEN: "zRMxEKpTw6AL3fdUdkSm7F3A1etkC4MG"
    volumes:
      - nfs_openclaw_conf:/home/node/.openclaw
      - nfs_openclaw_workspace:/home/node/.openclaw/workspace      
    stdin_open: true
    tty: true
    deploy:
      <<: [*deploy-common-ref, *placement-default-ref]

networks:
  network_cluster:
    external: true

volumes:
  # NFS
  nfs_homeassistant_conf:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/automation/homeassistant/conf
  nfs_n8n_data:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/automation/n8n/data
  nfs_n8n_ui:
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/automation/n8n/i18n/editor-ui-dist
  nfs_openclaw_conf: 
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/automation/openclaw/conf
  nfs_openclaw_workspace: 
    driver: local
    driver_opts:
      <<: *driver-common-ref
      device: :${NFS_DEVICE}/automation/openclaw/workspace      
...